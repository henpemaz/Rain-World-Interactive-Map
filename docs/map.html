<!DOCTYPE html>
<html>
<head>

    <meta charset="ISO-8859-1">
    <title>Rain World Interactive Map</title>

    <meta property="og:image" content="https://avatars0.githubusercontent.com/u/7621953?s=400&amp;v=4" />
    <meta property="og:site_name" content="GitHub" />
    <meta property="og:type" content="object" />
    <meta property="og:title" content="Rain World Interactive Map" />
    <meta property="og:url" content="https://henpemaz.github.io/Rain-World-Interactive-Map/index.html" />
    <meta property="og:description" content="A Rain World interactive map using leaflet and GeoJSON data exported from the game files. - henpemaz/Rain-World-Interactive-Map" />

    <link rel="stylesheet" href="./leaflet/leaflet.css" />
    <script src="./leaflet/leaflet.js"></script>
    <script src="./beziero.js"></script>

    <link rel="stylesheet" href="./rw.css" />
    <style id="mapstyle">
        body, html {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #mapid {
            height: 100%;
            padding: 0;
            margin: 0;
            background: black;
        }

        .room-labels {
            opacity: 0.4;
            pointer-events: auto;
            padding-top: 3px;
            padding-bottom: 3px;
            color: white;
            background-color: black;
            border: none;
        }

        .spawn-divs {
            display: flex;
            justify-content: center;
        }

        .spawn-entry {
            display: none; /* to be overwritten */
            margin-left: 16px;
            margin-right: 16px;
        }

        .lineage-entry {
            height: 24px;
        }

        .icon-image {
            position: absolute;
            margin-left: -25px;
            margin-top: -25px;
        }

        .icon-label {
            position: absolute;
            font-weight: 900;
            font-size: 100%;
            color: white;
            -webkit-text-fill-color: white; /* Will override color (regardless of order) */
            -webkit-text-stroke-width: 1px;
            -webkit-text-stroke-color: black;
        }

        /* Difficulty select and layers panel */
        .right-panel {
            position: absolute;
            top: 24px;
            right: 24px;
            background: #0c0c0c;
            z-index: 1000;
            color: #cccccc;
            width: fit-content;
            display: flex;
            flex-direction: row;
            align-items: center;
            overflow: hidden; /* hide on collapse */
        }

        .collapse-checkbox {
            margin: 0;
            appearance: none;
            position: absolute;
            display: block;
            width: 2.4em;
            height: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

            .collapse-checkbox:hover {
                background: #8f8f8f;
            }

            .collapse-checkbox::before {
                margin: 0;
                content: "\232a";
                color: #A9A4B2; /* menu lightgray */
                display: block;
                position: relative;
                text-align: center;
                font-size: 1.6em;
                font-weight: 600;
                width: 100%;
                transition: transform 0.3s, border 0.3s;
            }

            .collapse-checkbox:hover::before {
                transform: scaleX(1.2) scaleY(1.2);
                color: white;
            }

            .collapse-checkbox:checked::before {
                transform: rotate(180deg);
            }

        .collapsable {
            margin: 0;
            padding: 12px;
            margin-left: 36px;
            width: 160px;
            transition: 0.4s;
        }

        .collapse-checkbox:checked ~ .collapsable {
            margin-right: -184px;
            opacity: 0;
        }

        .difficulty-select {
            padding-bottom: 6px;
        }

        .difficulty-btn {
            display: inline-block;
            width: 38px;
            height: 38px;
            margin: 4px;
            position: relative;
        }

        .overlay-label {
            position: relative;
            width: 150px;
            height: 36px;
            margin-top: 11px;
            margin-bottom: 11px;
        }
    </style>

    <style id="spawnfilters">
        .spawn-filter-0 {
        }

        .spawn-filter-1 {
        }

        .spawn-filter-2 {
        }
    </style>

    <style id="hoverlabels">
        .hover-label {
            display: none;
        }
    </style>

</head>
<body>
    <div id="mapid"></div>

    <div class="right-panel rw-text">
        <input type="checkbox" name="display-right-panel" class="collapse-checkbox" autocomplete="off" />
        <br />
        <div class="collapsable">
            <div>Difficulty</div>
            <div class="difficulty-select">
                <label class="difficulty-btn">
                    <input type="radio" class="rw-ui" name="difficulties" onclick="show_difficulty(0);" value=0 autocomplete="off" checked="checked">
                    <img src="./resources/icons/17_slugcat.png">
                </label>
                <label class="difficulty-btn">
                    <input type="radio" class="rw-ui" name="difficulties" onclick="show_difficulty(1);" value=1 autocomplete="off">
                    <img src="./resources/icons/65_monk.png">
                </label>
                <label class="difficulty-btn">
                    <input type="radio" class="rw-ui" name="difficulties" onclick="show_difficulty(2);" value=2 autocomplete="off">
                    <img src="./resources/icons/64_hunter.png">
                </label>
            </div>

            <div>Layers</div>
            <div id="layer-content">
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // Utils

        // acquire json
        var requestLock = {};
        function getJsonObject(url, cb, async = true) {
            // Todo abort requests on region switch
            // read text from URL location
            let request = new XMLHttpRequest();
            requestLock = {};
            request.requestLock = requestLock;
            request.open('GET', url, async);
            request.onreadystatechange = function () {
                if (request.requestLock != requestLock && request.status != 0) {
                    request.abort();
                    console.log("request for " + url + " aborted!");
                }
                else if (request.readyState === 4 && request.status === 200) {
                    try {
                        cb(JSON.parse(request.responseText));
                    } catch (err) {
                        console.log(err);
                    }
                }
            }
            request.send();
        }

        // Control with poor control options, whodvathot
        // layer control with control over the classnames
        L.Control.Layers.UnstupidLayer = L.Control.Layers.extend(
            {
                options: {
                    collapsed: false,
                    containerClass: "",
                    sectionClass: "",
                    overlaysListClass: "",
                    overlayInputClass: "",
                    overlayInputDivClass: "",
                    overlayInputLabelClass: "",
                    hideBaseLayers: true
                },
                _addItem: function (obj) {
                    let h = L.Control.Layers.prototype._addItem.call(this, obj);
                    h.className = this.options.overlayInputDivClass;
                    h.children[0].className = this.options.overlayInputLabelClass;
                    h.children[0].children[0].className = this.options.overlayInputClass;
                    return h;
                },
                _initLayout: function () {
                    L.Control.Layers.prototype._initLayout.call(this);
                    this._container.className = this.options.containerClass;
                    this._section.className = this.options.sectionClass;
                    if (this.options.hideBaseLayers) {
                        this._baseLayersList.style.display = "none";
                        this._layersLink.style.display = "none";
                    }
                    this._overlaysList.className = this.options.overlaysListClass;
                },
                expand: function () { }
            }
        );

        // update difficulty filters
        var show_difficulty = function (n) {
            // Elements have a combination of these filters
            // as long as one matches, it should be displayed
            // parent class hides it, and if one of the sub classes unhides it we're good
            var sheet = document.getElementById('spawnfilters').sheet;
            for (var rule of sheet.cssRules) {
                if (rule.selectorText.startsWith(".spawn-filter-")) {
                    if (rule.selectorText.endsWith(n)) { // Show
                        rule.style.display = "initial";
                    }
                    else {
                        rule.style.removeProperty("display"); // unset
                    }
                }
            }
        };

        // Params
        let params = new URLSearchParams(document.location.search);
        var region = params.get("region");
        if (region == null) {
            window.location.href = "index.html";
        }
        var modded = params.get("modded") == 'on' || ['SU', 'HI', 'DS', 'CC', 'GW', 'SH', 'SL', 'SI', 'LF', 'UW', 'SS', 'SB'].indexOf(region) == -1;
        var room = params.get("room");
        var folderpath = 'tiles/' + (modded ? 'modded' : 'vanilla') + '/' + region + '/';

        // Map
        var map = L.map('mapid', {
            minZoom: -7,
            maxZoom: 3, // 8x
            crs: L.CRS.Simple
        });
        map.setView([0, 0], -5);

        // Overlay control
        var overlays = new L.Control.Layers.UnstupidLayer(null, null, {
            overlayInputClass: "rw-ui",
            overlayInputLabelClass: "overlay-label",
        });
        overlays.addTo(map);
        document.getElementById('layer-content').appendChild(overlays.getContainer());

        // Tileset layer
        var tileLayer = L.tileLayer(folderpath + '{z}/{x}_{y}.png', {
            attribution: "<a href=\"https://store.steampowered.com/app/312520/Rain_World/\">Rain World</a> by <a href=\"https://twitter.com/VideocultMedia\">Videocult</a>",
            minZoom: -7,
            maxZoom: 3,
            maxNativeZoom: 0 // important, stop requesting tiles at this point
        }).addTo(map);

        // Region stuff
        var roomsLayer;
        var roomNames;
        var lastRoomFocused;
        var connectionsLayer;
        var geometryLayer;
        var densLayer;
        getJsonObject(folderpath + "region.json", function (json) {
            // Background color
            map.getContainer().style.backgroundColor = 'rgb(' + json["bgcolor"].join(',') + ')'; // I hate this with passion

            roomNames = L.layerGroup();
            // Room features and name popups
            roomsLayer = L.geoJSON(json["room_features"], {
                style: {
                    weight: 0,
                    color: 'rgb(' + json["highlightcolor"].join(',') + ')',
                    fillOpacity: 0
                },
                onEachFeature: function (feature, layer) {
                    // Room focus stuff
                    layer.on({
                        mouseover: function (e) {
                            if (map.getZoom() < 0) {
                                e.target.setStyle({
                                    fillOpacity: 0.2
                                });
                                lastRoomFocused = e.target;
                            }
                        },
                        mouseout: function (e) { roomsLayer.resetStyle(e.target); if (lastRoomFocused == e.target) lastRoomFocused = null; },
                        click: function (e) { roomsLayer.resetStyle(e.target); map.fitBounds(e.target.getBounds()); },
                        tooltipopen: function (e) {
                            e.tooltip.setLatLng(L.latLng([].concat(e.target.feature.properties.popupcoords).reverse()));
                            e.tooltip.getElement().style.removeProperty('opacity'); // 'defaults' amirite
                        },
                    });

                    L.tooltip({ direction: "center", offset: [0, -14], permanent: true, className: "rw-text room-labels" }, layer).setContent(feature.properties.name).setLatLng(L.latLng([].concat(feature.properties.popupcoords).reverse())).addTo(roomNames);

                    layer.bindTooltip(feature.properties.name, { direction: "center", offset: [0, -14], interactive: true, className: "rw-text room-labels hover-label" });
                }
            }).addTo(map);
            overlays.addOverlay(roomsLayer, "Rooms");
            roomNames.addTo(map);
            overlays.addOverlay(roomNames, "Room Names");
            // remove room highlight on maxed zoom
            map.on('zoomend', function () { if (map.getZoom() >= 0 && lastRoomFocused) roomsLayer.resetStyle(lastRoomFocused); lastRoomFocused = null });
            // on Room Names view, prevent hover popups from displaying
            L.Tooltip.include({
                setOpacity: function (o) { } // fuck you
            });
            map.on('overlayadd', function (e) {
                if (e.name == "Room Names") {
                    document.getElementById('hoverlabels').sheet.cssRules[0].style.display = 'none';
                }
            });
            map.on('overlayremove', function (e) {
                if (e.name == "Room Names") {
                    document.getElementById('hoverlabels').sheet.cssRules[0].style.removeProperty("display");
                }
            });

            // Connections
            connectionsLayer = new L.BezierGeoJSON(json["connection_features"], {
                color: 'rgba(' + json["shortcutcolor"].join(',') + ',0.72)', // so the white looks better
                weight: 2,
                lineCap: "butt", // hehe
                dashArray: "5 8",
                interactive: false,
            }).addTo(map);
            overlays.addOverlay(connectionsLayer, "Connections");

            // Geometry
            geometryLayer = L.geoJSON(json["geo_features"], {
                interactive: false,
                color: 'rgb(' + json["geocolor"].join(',') + ')',
                weight: 2,
                lineCap: "butt", // im easily entertained
                lineJoin: "miter",
            }).addTo(map);
            overlays.addOverlay(geometryLayer, "Geometry");

            // Spawns
            densLayer = L.geoJSON(json["spawn_features"], {
                pointToLayer: function (feature, latlng) {
                    // Spawns are organized by dens, dens list spawns in it, flexbox stacks them visually on the den location, filter classes control visib
                    let divhtml = "";
                    for (let spawn of feature.properties.spawns) {
                        let spawn_filter = "";
                        for (let dif of spawn.difficulties) {
                            spawn_filter += " spawn-filter-" + dif;
                        }
                        if (spawn.is_lineage) {
                            // lineages are vertical stacks
                            divhtml += '<div class="spawn-entry' + spawn_filter + '">'
                            for (let i = 0; i < spawn.lineage.length; i++) {
                                divhtml += '<div class="lineage-entry"><img class="icon-image" src="./resources/icons/' + icon_by_name[spawn.lineage[i]] + '"/>' +
                                    '<div class="icon-label">' + (spawn.lineage_probs[i] * 100) + '%</div></div>';
                            }
                            divhtml += '</div>';
                        } else {
                            divhtml += '<div class="spawn-entry' + spawn_filter + '"><img class="icon-image" src="./resources/icons/' + icon_by_name[spawn.creature] + '"/>' +
                                '<div class="icon-label">x' + spawn.amount + '</div></div>';
                        }
                    }
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            className: 'spawn-divs',
                            html: divhtml,
                        }),
                        interactive: false,
                    });
                },
            }).addTo(map);
            overlays.addOverlay(densLayer, "Spawns");

            // Zoom to room on rooms loaded
            if (room != null) {
                for (let l of roomsLayer.getLayers()) {
                    if (l.feature.properties.name == room) {
                        map.fitBounds(l.getBounds());
                        break;
                    }
                }
            }

            show_difficulty(0);
        }, true);

        // misc iconography but mostly Spawns
        var icon_by_name = {
            "clear": "00_clear.png",
            "rock": "01_rock.png",
            "spear": "02_spear.png",
            "boomstick": "03_explosivespear.png",
            "bomb": "04_explosivebomb.png",
            "hive": "05_hive.png",
            "lantern": "06_lantern.png",
            "lure": "07_lureplant.png",
            "mushroom": "08_mushroom.png",
            "flashbang": "09_flashbomb.png",
            "puffball": "10_puffball.png",
            "waternut": "11_bubblefruit.png",
            "firecrackerplant": "12_firecrackerplant.png",
            "bluefruit": "13_bluefruit.png",
            "jellyfish": "14_jellyfish.png",
            "bubbleweed": "15_bubbleweed.png",
            "slimemold": "16_slimemold.png",
            "slugcat": "17_slugcat.png",
            //## Creatures from the World File
            "Green": "18_greenlizard.png",
            "Pink": "19_pinklizard.png",
            "Blue": "20_bluelizard.png",
            "White": "21_whitelizard.png",
            "Black": "22_molelizard.png",
            "Yellow": "23_orangelizard.png",
            "Cyan": "24_cyanlizard.png",
            "Red": "25_redlizard.png",
            "Salamander": "26_salamander.png",
            "batfly": "27_batfly.png",
            "CicadaA": "28_whitecicada.png",
            "CicadaB": "29_darkcicada.png",
            "Snail": "30_snailturtle.png",
            "Leech": "31_redleech.png",
            "Sea Leech": "32_blueleech.png",
            "Mimic": "33_poleplant.png",
            "TentaclePlant": "34_monsterkelp.png",
            "Tentacle Plant": "34_monsterkelp.png",
            "Scavenger": "35_scavenger.png",
            "vulturegrub": "36_vulturegrub.png",
            "Vulture": "37_vulture.png",
            "KingVulture": "38_kingvulture.png",
            "Small Centipede": "39_smallcentipede.png",
            "Centipede": "40_centipede.png",
            "Big Centipede": "41_bigcentipede.png",
            "Red Centipede": "42_redcentipede.png",
            "RedCentipede": "42_redcentipede.png",
            "Centiwing": "43_flyingcentipede.png",
            "grappleworm": "44_grappleworm.png",
            "Tube": "44_grappleworm.png",
            "TubeWorm": "44_grappleworm.png",
            "Tube Worm": "44_grappleworm.png",
            "hazer": "45_hazer.png",
            "Lantern Mouse": "46_lanternmouse.png",
            "Spider": "47_spider.png",
            "BigSpider": "48_bigspider.png",
            "Bigspider": "48_bigspider.png",
            "SpitterSpider": "49_spitterspider.png",
            "Miros Bird": "50_mirosbird.png",
            "Miros": "50_mirosbird.png",
            "Bro": "51_brotherlonglegs.png",
            "Daddy": "52_daddylonglegs.png",
            "Deer": "53_raindeer.png",
            "EggBug": "54_bubblebug.png",
            "Eggbug": "54_bubblebug.png",
            "DropBug": "55_dropwig.png",
            "Dropbug": "55_dropwig.png",
            "DropWig": "55_dropwig.png",
            "Dropwig": "55_dropwig.png",
            "BigNeedleWorm": "56_noodlefly.png",
            "SmallNeedleWorm": "57_babynoodlefly.png",
            "Jet Fish": "58_jetfish.png",
            "JetFish": "58_jetfish.png",
            "Jetfish": "58_jetfish.png",
            "Leviathan": "59_leviathan.png",
            "randomitems": "60_randomitems_inactive.png",
            "NONE": "63_none.png",
            //## Difficulties
            "survivor": "17_slugcat.png",
            "hunter": "64_hunter.png",
            "monk": "65_monk.png",
            //## Missing stuff
            "Garbage Worm": "00_clear.png",
        }

    </script>
</body>
</html>
